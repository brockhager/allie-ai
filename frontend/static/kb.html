<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Allie â€” Knowledge Base</title>
  <style>
    /* Dark themed KB to match the main app and ensure high contrast inside iframe */
    :root{--bg:#071226;--panel:#071226;--muted:#9ca3af;--text:#e6eef6;--accent:#60a5fa;--card:#0b1726}
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{padding:18px;max-width:1200px;margin:0 auto}
    h1{margin:0 0 12px 0;color:var(--accent);font-size:20px}
    table{width:100%;border-collapse:collapse;background:transparent}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:top;font-size:14px}
    th{background:transparent;text-align:left;color:var(--muted);font-size:13px}
    td{color:var(--text)}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.015)}
    .toolbar{margin:12px 0 18px 0;display:flex;gap:8px;align-items:center}
    .btn{padding:8px 10px;border-radius:8px;background:var(--accent);color:#021125;border:none;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
    .input{padding:8px;border:1px solid rgba(255,255,255,0.06);border-radius:8px;background:transparent;color:var(--text);min-width:180px}
    /* Modal (dark) */
    #modal{display:none;position:fixed;left:50%;top:12%;transform:translateX(-50%);background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:16px;box-shadow:0 12px 40px rgba(2,6,23,0.6);border-radius:8px;z-index:999}
    #modal h3{margin:0 0 8px 0;color:var(--accent)}
    #modal .input, #modal textarea{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.04)}
    /* Responsive adjustments */
    @media (max-width:900px){ th,td{font-size:13px;padding:8px} h1{font-size:18px} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Knowledge Base</h1>
    <div id="countDisplay" style="margin: 0 0 12px 0; color: var(--muted); font-size: 14px;">Count: Loading...</div>
    <div class="toolbar">
      <input id="filterStatus" class="input" placeholder="Filter status (true,false,not_verified)" />
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="newBtn" class="btn">Add Fact</button>
    </div>
    <div id="tableWrap">Loading...</div>
  </div>

  <!-- Simple modal for add/edit -->
  <div id="modal">
    <h3 id="modalTitle">Add KB Fact</h3>
    <div style="display:flex;flex-direction:column;gap:10px;max-width:900px">
      <input id="m_keyword" class="input" placeholder="keyword" />
      <textarea id="m_fact" rows="6" class="input" placeholder="fact"></textarea>
      <input id="m_source" class="input" placeholder="source" />
      <select id="m_status" class="input"><option value="true">true</option><option value="false">false</option><option value="not_verified">not_verified</option><option value="needs_review">needs_review</option><option value="experimental">experimental</option></select>
      <input id="m_conf" class="input" type="number" value="90" min="0" max="100" />
      <div style="display:flex;gap:8px"><button id="m_save" class="btn">Save</button><button id="m_cancel" class="btn ghost">Cancel</button></div>
    </div>
  </div>

<script>
async function fetchKB(status){
  const qs = status ? `?status=${encodeURIComponent(status)}` : '';
  const res = await fetch('/api/kb' + qs);
  if(!res.ok) {
    const errText = await res.text();
    console.error('KB fetch error:', errText);
    throw new Error('Failed to fetch: ' + res.status + ' - ' + errText);
  }
  return res.json();
}

async function fetchKBTotalCount(){
  const res = await fetch('/api/kb');
  if(!res.ok) {
    const errText = await res.text();
    console.error('KB total count fetch error:', errText);
    throw new Error('Failed to fetch total count: ' + res.status + ' - ' + errText);
  }
  const data = await res.json();
  return data.facts ? data.facts.length : 0;
}

function renderTable(data){
  console.log('Rendering table with data:', data);
  if(!data || !data.facts || !Array.isArray(data.facts)){
    console.error('Invalid data structure:', data);
    document.getElementById('tableWrap').textContent = 'No facts data available';
    return;
  }
  if(data.facts.length === 0){
    document.getElementById('tableWrap').innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">No KB entries found. Click "Add Fact" to create one.</div>';
    return;
  }
  const rows = data.facts.map(r=>`<tr data-id="${r.id}"><td>${r.id}</td><td>${r.keyword}</td><td>${r.fact}</td><td>${r.source}</td><td>${r.status}</td><td>${r.confidence_score}</td><td>${r.updated_at}</td><td><button class="edit">Edit</button> <button class="del">Delete</button></td></tr>`).join('');
  document.getElementById('tableWrap').innerHTML = `<table><thead><tr><th>ID</th><th>Keyword</th><th>Fact</th><th>Source</th><th>Status</th><th>Confidence</th><th>Updated</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
  console.log(`Table rendered with ${data.facts.length} rows`);
  document.querySelectorAll('button.edit').forEach(b=>b.onclick = onEdit);
  document.querySelectorAll('button.del').forEach(b=>b.onclick = onDelete);
}

async function refresh(){
  try{
    const status = document.getElementById('filterStatus').value.trim();
    const data = await fetchKB(status || undefined);
    console.log('KB data loaded:', data);
    renderTable(data);
    
    // Always fetch and display total count
    const totalCount = await fetchKBTotalCount();
    document.getElementById('countDisplay').textContent = `Count: ${totalCount}`;
  }catch(e){
    console.error('Refresh error:', e);
    document.getElementById('tableWrap').textContent = 'Failed to load: '+e.message;
    document.getElementById('countDisplay').textContent = 'Count: 0';
  }
}

function showModal(edit){
  document.getElementById('modal').style.display = 'block';
  document.getElementById('modalTitle').textContent = edit ? 'Edit KB Fact':'Add KB Fact';
  if(!edit){document.getElementById('m_keyword').value='';document.getElementById('m_fact').value='';document.getElementById('m_source').value='internal';document.getElementById('m_conf').value='90';}
}

function hideModal(){document.getElementById('modal').style.display='none';}

let editingId = null;
async function onEdit(e){
  const tr = e.target.closest('tr'); editingId = tr.dataset.id;
  const cells = tr.children;
  document.getElementById('m_keyword').value = cells[1].textContent;
  document.getElementById('m_fact').value = cells[2].textContent;
  document.getElementById('m_source').value = cells[3].textContent;
  document.getElementById('m_status').value = cells[4].textContent;
  document.getElementById('m_conf').value = cells[5].textContent;
  showModal(true);
}
async function onDelete(e){
  if(!confirm('Delete this KB fact?')) return;
  const id = e.target.closest('tr').dataset.id;
  const res = await fetch('/api/kb/'+id, { method: 'DELETE' });
  if(!res.ok){ alert('Delete failed'); return; }
  await refresh();
}

document.getElementById('refreshBtn').onclick = refresh;
document.getElementById('newBtn').onclick = ()=>{ editingId=null; showModal(false); };
document.getElementById('m_cancel').onclick = hideModal;

document.getElementById('m_save').onclick = async ()=>{
  const payload = { keyword: document.getElementById('m_keyword').value.trim(), fact: document.getElementById('m_fact').value.trim(), source: document.getElementById('m_source').value.trim(), status: document.getElementById('m_status').value, confidence_score: Number(document.getElementById('m_conf').value) };
  if(!payload.keyword || !payload.fact){ alert('keyword and fact required'); return; }
  try {
    if(editingId){
      const res = await fetch('/api/kb/'+editingId, { method: 'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) {
        const errText = await res.text();
        alert('Update failed: ' + errText);
        return;
      }
    } else {
      const res = await fetch('/api/kb', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) {
        const errText = await res.text();
        alert('Create failed: ' + errText);
        console.error('KB Create error:', errText);
        return;
      }
      const result = await res.json();
      console.log('KB fact created:', result);
    }
    hideModal();
    await refresh();
  } catch(err) {
    alert('Error saving KB fact: ' + err.message);
    console.error('Save error:', err);
  }
}

// initial load
refresh();
</script>
</body>
</html>
